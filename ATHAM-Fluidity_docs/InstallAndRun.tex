\documentclass[10pt,a4paper]{article}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amsfonts}
\usepackage{amssymb}
%\usepackage{natbib}
%\bibliographystyle{../../References/te}
\usepackage{hyperref}
\usepackage{seqsplit}
\usepackage[tmargin=1in,bmargin=1in,lmargin=1.25in,rmargin=1.25in]{geometry}
\renewcommand\labelitemii{$\circ$}
\newcommand\tab[1][0.5cm]{\hspace*{#1}}
\title{ATHAM-Fluidity: How to Install and Run}
\date{}
\begin{document}

\maketitle
\tableofcontents


\section{Downloading ATHAM-Fluidity}
The ATHAM-Fluidity repository is found on GitHub at \url{https://github.com/FluidityProject/ATHAM-Fluidity}. To download the repository onto a Linux machine (that has \texttt{git} installed), open up a terminal window and navigate to the directory under which you wish to store your local copy of ATHAM-Fluidity. Then type the following command (after the command prompt `\texttt{\$}'):\\\\
\tab \texttt{\$ git clone https://github.com/FluidityProject/ATHAM-Fluidity.git}

\section{Dependencies and environment variables} \label{Dependencies}
ATHAM-Fluidity requires a certain number of dependencies (external packages and libraries) to be installed before it can be compiled. An essential step before compiling ATHAM-Fluidity is therefore to make sure that all these dependencies are present and can be reached by the code. There are three possible ways to achieve this, depending on the system you are using:
\begin{itemize}
\item \textbf{Install the \texttt{fluidity-dev} package}. This installs all the dependencies automatically, using default versions and install locations. This procedure is described in Section \ref{FluidityDev}
\item \textbf{Self-installation}. Each dependency can be installed separately if desired (e.g. if the user wants to install non-default versions of the dependencies or choose different install locations). This procedure is described in Section \ref{Self}
\item \textbf{Loading modules}. This procedure can be followed if you are running ATHAM-Fluidity on a cluster that uses environment modules, and the dependencies have already been centrally built by a system administrator. Section \ref{Darwin} describes how to load the relevant modules on the University of Cambridge's Darwin HPC.
\end{itemize}

\subsection{Installing the \texttt{fluidity-dev} package} \label{FluidityDev}
With the Ubuntu operating system, the \texttt{fluidity-dev} package can be installed from the terminal window by issuing the following three commands (assuming that the user has administrative `\texttt{sudo}' privileges):\\\\
\tab \texttt{\$ sudo apt-add-repository -y ppa:fluidity-core/ppa}\\
\tab \texttt{\$ sudo apt-get update}\\
\tab \texttt{\$ sudo apt-get install fluidity-dev}\\\\
It is also necessary to issue the following command before the configure stage:\\\\
\tab \texttt{\$ export petsc\_dir=/usr/lib/petscdir/3.6.3}\\\\
At the time of writing this document, the \texttt{fluidity-dev} package installs PETSc version 3.6.3. It is possible that this has changed since then, in which case the `3.6.3' in the above command should be replaced with the newer version number, which can be found by issuing the command `\texttt{\$ ls /usr/lib/petscdir}'. It is recommended that you also add the above export line (minus the command prompt) to your \texttt{.bashrc} file, located in your home directory, so that these environment variables are remembered for every login session.\\\\
Note that Fluidity (and thus ATHAM-Fluidity) is only supported for use with the GNU Compiler Collection (GCC) and OpenMPI executables. It is possible that a different compiler collection (e.g. Intel, Portland Group, etc.) is set up as the default on your system. Use of the supported executables can be ensured by setting the following environment variables:\\\\
\tab \texttt{\$ export CC=gcc}\\
\tab \texttt{\$ export CXX=g++}\\
\tab \texttt{\$ export CPP=cpp}\\
\tab \texttt{\$ export FC=gfortran}\\
\tab \texttt{\$ export F90=gfortran}\\
\tab \texttt{\$ export F77=gfortran}\\
\tab \texttt{\$ export PATH=/usr/bin:\$PATH}\\\\
Again, it is recommended that you also add the above lines to your \texttt{.bashrc} if you want the same behaviour for every login session.

\subsection{Self-installation} \label{Self}
The following section describes the installation of the ATHAM-Fluidity dependencies on a Linux machine that was running Ubuntu 16 LTS. It is assumed that the user has administrative `\texttt{sudo}' privileges.\\\\
When newer versions of the dependencies are released, it takes time for their compatibility to be fully tested by the model developers, and so version support often lags behind the most recent versions of these dependencies. For this reason, it is recommended to install the dependencies from source code, with versions that are known to be stable, rather than using a package management tool (e.g. `\texttt{apt-get install}' on Ubuntu) which will install the most recent version of the dependency by default. It is recommended to install each dependency in a separate sub-directory, under a location that can be reached by all users. Here, we will install each dependency in a sub-directory under \texttt{/usr/local/fluidity/}. The first step is therefore to create this directory:\\\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity}

\subsubsection{GNU compilers}
The GNU Compiler Collection (GCC) should come pre-installed with Ubuntu. You can check the version (and existence) of GCC installed on your system by typing:\\\\
\tab \texttt{\$ gcc --version}\\\\
Here, we are using gcc 5.4.0. It is possible that another compiler collection (e.g. Intel, Portland Group, etc.) is set up as the default on your system; see Section \ref{FluidityDev} for instructions on how to ensure that the GCC compilers are always used.

\subsubsection{Python}
Python should also come pre-installed with Ubuntu. Again, you can check the (default) version on your system by typing `\texttt{python --version}' at the command prompt. Here, we are using Python 2.7.12. Note that Python 3 is not yet supported - you may therefore have to change the symbolic link \texttt{/usr/bin/python} to point to an earlier version of the python executable, e.g. python2.7. There are also a number of Python packages that are required for ATHAM-Fluidity to build. Again, these packages are typically installed by default. One important package is NumPy. It is possible to check whether NumPy is installed by typing the following at the command line:\\\\
\tab \texttt{\$ python -c "import numpy; print numpy.\_\_version\_\_"}\\\\
Here, we are using NumPy 1.11.0. If you see an import error, you should install the NumPy package manually.

\subsubsection{OpenMPI}
ATHAM-Fluidity must be built with MPI support, even if the model will only be run on a single processor rather than in parallel. It is recommended to install OpenMPI. Here, we install OpenMPI 1.6.5. The source code can be download from \url{https://www.open-mpi.org/software/ompi/v1.6/} (choose the gzipped tarfile, i.e. openmpi-1.6.5.tar.gz). Untar the file somewhere locally and move into the untarred directory. Also, create a sub-directory under \texttt{/usr/local/fluidity} ready for installation:\\\\
\tab \texttt{\$ tar -xzvf openmpi-1.6.5.tar.gz}\\
\tab \texttt{\$ cd openmpi-1.6.5}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/openmpi-1.6.5}\\\\
OpenMPI is then built by issuing the following three commands:\\\\
\tab \texttt{\$ ./configure --prefix=/usr/local/fluidity/openmpi-1.6.5}\\
\tab \texttt{\$ make}\\
\tab \texttt{\$ sudo make install}\\\\
Once installation is complete, you may (if you wish) delete the local openmpi-1.6.5 directory and tarfile. In order that the OpenMPI executables can be found when building ATHAM-Fluidity (as well as some of the dependencies below), you will need to issue the following command (and add it to your \texttt{.bashrc} file if you want the same behaviour for every login session):\\\\
\tab \texttt{\$ export PATH=/usr/local/fluidity/openmpi-1.6.5/bin:\$PATH}


\subsubsection{BLAS and LAPACK}
The linear algebra solvers BLAS and LAPACK are both required by the model. Netlib provide an implementation of these packages. The source codes can be downloaded from \url{http://www.netlib.org/blas/} and \url{http://www.netlib.org/lapack/}, respectively. Here, we download and install BLAS 3.6.0 (blas-3.6.0.tgz) and LAPACK 3.4.2 (lapack-3.4.2.tgz). First, untar BLAS locally, move into the untarred directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf blas-3.6.0.tgz}\\
\tab \texttt{\$ cd BLAS-3.6.0}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/BLAS-3.6.0}\\\\
Next, open the file \texttt{make.inc} using your preferred text editor (e.g. \texttt{gedit}) and modify the variables \texttt{OPTS} and \texttt{BLASLIB} so that they read:\\\\
\tab \texttt{OPTS = -O3 -fPIC}\\
\tab \texttt{BLASLIB = /usr/local/fluidity/BLAS-3.6.0/libblas.a}\\\\
The BLAS library is then installed by issuing the following command:\\\\
\tab \texttt{\$ sudo make}\\\\
Now untar LAPACK locally, move into the untarred directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf lapack-3.4.2.tgz}\\
\tab \texttt{\$ cd lapack-3.4.2}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/lapack-3.4.2}\\\\
Next, make a copy of the file \texttt{make.inc.example}, calling it \texttt{make.inc}, i.e. type:\\\\
\tab \texttt{\$ cp make.inc.example make.inc}\\\\
Open \texttt{make.inc} using your preferred text editor and modify the following lines so that they read:\\\\
\tab \texttt{OPTS = -O2 -fPIC}\\
\tab \texttt{LOADOPTS = -fPIC}\\
\tab \texttt{CFLAGS = -O3 -fPIC}\\
\tab \texttt{BLASLIB = /usr/local/fluidity/BLAS-3.6.0/libblas.a}\\\\
The LAPACK library file is then built by issuing the `\texttt{make}' command, after which the file must be manually copied into the install directory:\\\\
\tab \texttt{\$ make}\\
\tab \texttt{\$ sudo cp liblapack.a /usr/local/fluidity/lapack-3.4.2/.}\\\\
Note that no environment variables need to be set for BLAS and LAPACK - you will tell ATHAM-Fluidity where to find these libraries directly in the configure command.

\subsubsection{PETSc}
PETSc is used to provide matrix solvers in ATHAM-Fluidity. Here, we install PETSc 3.5.4. The source code can be downloaded from \url{http://www.mcs.anl.gov/petsc/download/} (petsc-3.5.4.tar.gz). Untar this file locally, move into the untarred directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf petsc-3.5.4.tar.gz}\\
\tab \texttt{\$ cd petsc-3.5.4}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/petsc-3.5.4}\\\\
PETSc has some dependencies of its own that need to be installed before configuring and installing PETSc itself. Of these dependencies, those that are most likely not on your system by default are \texttt{cmake}, \texttt{bison} and \texttt{flex}. It should be safe to install the latest releases of these dependencies, and so the command line package management tool can be used. On Ubuntu, you would issue the following commands:\\\\
\tab \texttt{\$ sudo apt-get update}\\
\tab \texttt{\$ sudo apt-get install cmake bison flex}\\\\
Next, issue the following command to configure PETSc:\\\\
\tab \texttt{\$ ./configure --prefix=/usr/local/fluidity/petsc-3.5.4 \seqsplit{--download-fblaslapack=1} --download-blacs=1 --download-scalapack=1 --download-ptscotch=1 \seqsplit{--download-mumps=1} --download-hypre=1 --download-suitesparse=1 --download-ml=1 \seqsplit{--with-fortran-interfaces=1}}\\\\
After a successful configuration, you should see something similar to the following output in the terminal window:\\\\
\tab \texttt{Configure stage complete. Now build PETSc libraries with (gnumake build):\\
\tab \tab make PETSC\_DIR=/home/jjo31/tarfiles/petsc-3.5.4 \seqsplit{PETSC\_ARCH=arch-linux2-c-debug} all}\\\\
Copy and paste the entire line starting with `\texttt{make}' from your terminal into the command prompt and press Enter. After this stage has completed successfully, you should see something similar to the following output in the terminal window:\\\\
\tab \texttt{Now to install the libraries do:}\\
\tab \texttt{make PETSC\_DIR=/home/jjo31/tarfiles/petsc-3.5.4 \seqsplit{PETSC\_ARCH=arch-linux2-c-debug} install}\\\\
Again, copy and paste the entire line starting with `\texttt{make}' from your terminal into the command prompt, but this time add \texttt{`sudo'} to the beginning of the line before pressing Enter. You should then see something similar to the following output in the terminal window:\\\\
\tab \texttt{Install complete.}\\
\tab \texttt{Now to check if the libraries are working do (in current directory):}\\
\tab \texttt{make PETSC\_DIR=/usr/local/fluidity/petsc-3.5.4 PETSC\_ARCH="" test}\\\\
You can copy-paste the final line from your terminal into the command prompt to make sure that PETSc has been installed successfully. Finally, it is necessary to set the following environment variable (and add it to your \texttt{.bashrc} file for future login sessions) so that ATHAM-Fluidity knows where to find the PETSc files during compilation:\\\\
\tab \texttt{\$ export PETSC\_DIR=/usr/local/fluidity/petsc-3.5.4}

\subsubsection{ParMETIS and Zoltan}
Domain decomposition for parallel runs with ATHAM-Fluidity is performed through the partitioning and load balancing software Zoltan. Zoltan must be configured with the mesh-partitioning library ParMETIS, which should therefore be installed first. Here, we install ParMETIS 3.1.1. The source code can be downloaded from \url{http://glaros.dtc.umn.edu/gkhome/fsroot/sw/parmetis/OLD} (ParMetis-3.1.1.tar.gz). Untar this file locally, move into the untarred directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf ParMetis-3.1.1.tar.gz}\\
\tab \texttt{\$ cd ParMetis-3.1.1}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/ParMetis-3.1.1}\\\\
ParMETIS is then built by issuing the `\texttt{make}' command, after which the library and header files must be manually copied into the install directory:\\\\
\tab \texttt{\$ make}\\
\tab \texttt{\$ sudo cp lib*.a parmetis.h /usr/local/fluidity/ParMetis-3.1.1/.}\\\\
Next, download the Zoltan source code from \url{http://www.cs.sandia.gov/Zoltan/Zoltan\_download.html}. Here, we install Zoltan 3.83. Untar the downloaded tarfile locally, create a directory called \texttt{Zoltan-build} (Zoltan should be built in a separate directory to the source directory), move into this directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf zoltan\_distrib\_v3.83.tar.gz}\\
\tab \texttt{\$ mkdir Zoltan-build}\\
\tab \texttt{\$ cd Zoltan-build}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/Zoltan\_v3.83}\\\\
It is also necessary to specify whether you are installing Zoltan on a 32- or 64-bit system. This can be determined by issuing the following command:\\\\
\tab \texttt{\$ uname -i}\\\\
For a 64-bit system this will return something like \texttt{`x86\_64'}, whereas for a 32-bit system it will return something like \texttt{`i386'}. To configure Zoltan, issue the following command (replacing the \texttt{`x86\_64'} to be consistent with your system, if necessary):\\\\
\tab \texttt{env CC=`' CXX=`' CPP=`' FC=`' F90=`' F77=`' ../Zoltan\_v3.83/configure \seqsplit{x86\_64-linux-gnu} --prefix=/usr/local/fluidity/Zoltan\_v3.83 --enable-mpi \seqsplit{--enable-f90interface} --disable-examples --with-parmetis \seqsplit{--with-parmetis-libdir=/usr/local/fluidity/ParMetis-3.1.1} --with-parmetis-incdir=/usr/local/fluidity/ParMetis-3.1.1}\\\\
Note that the text before the \texttt{configure} command temporarily `unsets' the compiler environment variables that we set previously - this is required because the configure script would otherwise think that these were the names of the MPI compilers, which is not the case. Next, issue the following two commands to compile and install Zoltan on your system:\\\\
\tab \texttt{\$ make}\\
\tab \texttt{\$ sudo make install}\\\\
Finally, it is necessary to set the following environment variables (and add them to your \texttt{.bashrc} file for future login sessions) so that ATHAM-Fluidity knows where to find the ParMETIS and Zoltan files during compilation:\\\\
\tab \texttt{\$ export LDFLAGS=`-L/usr/local/fluidity/ParMetis-3.1.1 \seqsplit{-L/usr/local/fluidity/Zoltan\_v3.83/lib'}}\\
\tab \texttt{\$ export CPPFLAGS=`-I/usr/local/fluidity/ParMetis-3.1.1 \seqsplit{-I/usr/local/fluidity/Zoltan\_v3.83/include'}}

\subsubsection{VTK}
VTK is required by ATHAM-Fluidity for its data output methods. The VTK install described below requires the following packages to be present on your system, which can be installed using `\texttt{apt-get}' with Ubuntu:\\\\
\tab \texttt{\$ sudo apt-get update}\\
\tab \texttt{\$ sudo apt-get install cmake-curses-gui tcl-dev tk-dev}\\\\
Next, download the VTK source code from \url{http://www.vtk.org/download/}. Here we install VTK 5.10.1 (vtk-5.10.1.tar.gz). Untar the downloaded tarfile locally, create a directory called \texttt{VTK-build} (VTK should be built in a separate directory to the source directory), move into this directory, and prepare an install directory:\\\\
\tab \texttt{\$ tar -xzvf vtk-5.10.1.tar.gz}\\
\tab \texttt{\$ mkdir VTK-build}\\
\tab \texttt{\$ cd VTK-build}\\
\tab \texttt{\$ sudo mkdir /usr/local/fluidity/VTK5.10.1}\\\\
It is also necessary to set the following environment variable (and add it to your \texttt{.bashrc} file for future login sessions):\\\\
\tab \texttt{\$ export \seqsplit{PYTHONPATH=/usr/local/fluidity/VTK5.10.1/lib/python2.7/site-packages:\$PYTHONPATH}}\\\\
To start the VTK configuration process, issue the following command:\\\\
\tab \texttt{\$ ccmake ../VTK5.10.1}\\\\
This opens up an interactive configure window inside the terminal. Press \texttt{c} to start the initial configure. Once this is complete, press \texttt{e} to be given a list of additional configuration options. Using the arrow keys, Enter key, and keyboard, modify the following options (the rest can be left as they are):\\\\
\tab \texttt{BUILD\_SHARED\_LIBS = ON}\\
\tab \texttt{CMAKE\_INSTALL\_PREFIX = /usr/local/fluidity/VTK5.10.1}\\
\tab \texttt{VTK\_USE\_CHARTS = OFF}\\
\tab \texttt{VTK\_USE\_GEOVIS = OFF}\\
\tab \texttt{VTK\_USE\_INFOVIS = OFF}\\
\tab \texttt{VTK\_USE\_N\_WAY\_ARRAYS = OFF}\\
\tab \texttt{VTK\_USE\_VIEWS = OFF}\\
\tab \texttt{VTK\_WRAP\_PYTHON = ON}\\\\
Press \texttt{c} to reconfigure. Once complete, press \texttt{e}, followed by \texttt{c} and \texttt{e} again. You should now have the option to `generate' by pressing \texttt{g}. This will take you back to the standard command line, where you can then build and install VTK by issuing the following commands:\\\\
\tab \texttt{\$ make}\\
\tab \texttt{\$ sudo PYTHONPATH=/usr/local/fluidity/VTK5.10.1/lib/python2.7/site-packages make install}\\\\
Note that the `\texttt{sudo}' command does not preserve user environment variables, which is why PYTHONPATH has to be passed in to `\texttt{make install}' despite having been added to the user environment previously. Finally, it is necessary to set the following environment variables (and add them to your \texttt{.bashrc} file for future login sessions) so that ATHAM-Fluidity knows where to find the VTK files during compilation:\\\\
\tab \texttt{\$ export VTK\_INCLUDE=/usr/local/fluidity/VTK5.10.1/include/vtk-5.10}\\
\tab \texttt{\$ export LDFLAGS=\$LDFLAGS` -L/usr/local/fluidity/VTK5.10.1/lib/vtk-5.10'}\\
\tab \texttt{\$ export \seqsplit{LD\_LIBRARY\_PATH=\$LD\_LIBRARY\_PATH:/usr/local/fluidity/VTK5.10.1/lib/vtk-5.10}}

\subsection{Loading modules on Darwin} \label{Darwin}
The dependencies required by ATHAM-Fluidity have already been installed centrally on Darwin. All that is required to prepare the model is therefore to load the relevant modules and set some environment variables. Note that the Intel compiler collection (not GCC) was used to install these dependencies. Specifically, the 2014 version-set was used. As this is not the version-set loaded by default at login, the first step is to unload these default modules and load the appropriate ones. This can be done by issuing the following commands (and adding them to your \texttt{.bash\_profile} file in your home directory so that this is done for every login session):\\\\
\tab \texttt{\$ module unload intel/impi/4.1.3.045}\\
\tab \texttt{\$ module unload intel/fce/12.1.10.319}\\
\tab \texttt{\$ module unload intel/cce/12.1.10.319}\\
\tab \texttt{\$ module unload intel/mkl/10.3.10.319}\\
\tab \texttt{\$ module load intel/impi/5.0.2.044}\\
\tab \texttt{\$ module load intel/fce/15.0.1.133}\\
\tab \texttt{\$ module load intel/cce/15.0.1.133}\\
\tab \texttt{\$ module load intel/mkl/11.2.1.133}\\\\
Note that the first four lines correspond to the Intel modules that are loaded by default on Darwin at the time of writing this document. It is possible that these modules have changed since then, in which case you should modify these lines accordingly. It is possible to see the list of modules loaded by default by typing `\texttt{module list}' into the command line after login. The rest of the dependencies are then loaded by issuing the following commands (add them to your \texttt{.bash\_profile} too):\\\\
\tab \texttt{\$ module load petsc/intel15/3.5.3}\\
\tab \texttt{\$ module load zoltan/3.83}\\
\tab \texttt{\$ module load vtk/5.6.1}\\\\
Finally, although some of the required environment variables are automatically set when the modules are loaded, there are still a few variables that need to be set manually (add them to your \texttt{.bash\_profile} too):\\\\
\tab \texttt{\$ export CPPFLAGS=`-I/usr/local/Cluster-Apps/zoltan/3.83/include'}\\
\tab \texttt{\$ export VTK\_INCLUDE=/usr/local/Cluster-Apps/vtk/5.6.1/include/vtk-5.6}\\
\tab \texttt{\$ export LDFLAGS=`-L/usr/local/Cluster-Apps/vtk/5.6.1/lib/vtk-5.6'}

\section{Installing ATHAM-Fluidity}
ATHAM-Fluidity must first be properly configured so that it can be linked to the relevant libraries outlined in Section \ref{Dependencies}. A minimum configuration is achieved by issuing the following command from inside the main directory of your ATHAM-Fluidity repository:\\\\
\tab \texttt{\$ ./configure --enable-2d-adaptivity}\\\\
For users that have installed the BLAS and LAPACK libraries manually, their location should be passed to the configure command as follows:\\\\
\tab \texttt{\$ ./configure --enable-2d-adaptivity \seqsplit{--with-blas=/usr/local/fluidity/BLAS-3.6.0/libblas.a} \seqsplit{--with-lapack=/usr/local/fluidity/lapack-3.4.2/liblapack.a}}\\\\
This assumes that the BLAS and LAPACK libararies were installed in the locations as speficied in Section \ref{Self}; if they were installed elsewhere, modify the paths accordingly. A debug build of ATHAM-Fluidity is obtained by adding the flag \texttt{--enable-debugging} to the configure command. Information about further configure flags can be obtained using the command:\\\\
\tab \texttt{\$ ./configure --help}\\\\
To compile ATHAM-Fluidity after a successful configure, simply type:\\\\
\tab \texttt{\$ make}\\\\
In addition to the standard `\texttt{make}' above, a set of useful tools (including the `\texttt{flredecomp}' executable, required for domain decomposition for parallel runs) should also be compiled by typing:\\\\
\tab \texttt{\$ make fltools}\\\\
If not otherwise specified, the model and tool executables will be placed in the following directory: \texttt{<A-F\_install\_path>/bin}, where \texttt{<A-F\_install\_path>} is the path to your local ATHAM-Fluidity repository. It can be useful to add this directory to your \texttt{\$PATH} environment variable so that the executables can be launched simply by typing their name rather than their entire path. This is done by issuing the following command (and adding it to your \texttt{.bashrc} file for future login sessions):\\\\
\tab \texttt{\$ export PATH=<A-F\_install\_path>/bin:\$PATH }\\\\
Diamond, the GUI used to generate ATHAM-Fluidity input parameter (\texttt{.flml}) files, is built and then linked to the appropriate options-tree (`schema') file by typing the following two commands:\\\\
\tab \texttt{\$ make install-diamond}\\
\tab \texttt{\$ make install-user-schemata}\\\\
If not specified otherwise, the `\texttt{diamond}' executable will be placed in the following directory: \texttt{<A-F\_install\_path>/libspud/diamond/bin}. Again, to be able to launch the executable simply by typing `\texttt{diamond}', you can modify your \texttt{\$PATH} environment variable by typing (and adding to your \texttt{.bashrc} file for future login sessions) :\\\\
\tab \texttt{\$ export PATH=<A-F\_install\_path>/libspud/diamond/bin:\$PATH }\\\\
Note that the location of the default \texttt{.flml} can be found in the following directory: \texttt{\$HOME/\seqsplit{.diamond/schemata/flml}}.\\\\
Finally, local Python scripts should also be made accessible by setting the following environment variable (and adding to your \texttt{.bashrc} file for future login sessions):\\\\
\tab \texttt{\$ export PYTHONPATH=\$PYTHONPATH:<A-F\_install\_path>/python}

\section{Running ATHAM-Fluidity}
A typical workflow when setting up and running an ATHAM-Fluidity simulation consists of the following four steps:
\begin{enumerate}
\item Creating an ATHAM-Fluidity model options (\texttt{.flml}) file. This procedure is described in Section \ref{Config}.
\item Defining the geometry of the numerical modelling domain and creating the (initial/static) mesh. This procedure is described in Section \ref{Mesh}.
\item Decomposing the numerical domain into a number of smaller sub-domains in preparation for a parallel run on multiple processes. This procedure is described below.
\item Invoking the main model executable on the appropriate number of processes. This procedure is described below.
\end{enumerate}
After the first two steps have been completed, for a parallel run, the numerical domain must first be decomposed using the \texttt{flredecomp} tool. This is done by issuing the following command from within the main simulation directory (where the model options (\texttt{.flml}) file is located):\\\\
\tab \texttt{\$ mpiexec -n Y flredecomp -i X -o Y <original\_input\_file> <parallel\_input\_file>}\\\\
The above command assumes that \texttt{<A-F\_install\_path>/bin} has been added to your \texttt{\$PATH} environment variable. The argument \texttt{-i} is used to specify the initial number of processes (sub-domains) \texttt{X} (typically \texttt{X}=1), and the arguments \texttt{-n} and \texttt{-o} are used to specify the output number of processes (sub-domains) \texttt{Y} on which the model executable will be run. \texttt{<original\_input\_file>} is the name of the original model options (\texttt{.flml}) file \textit{without the extension}, while \texttt{\seqsplit{<parallel\_input\_file>}} is the name of the \texttt{.flml} file (again without the extension) that will be generated by \texttt{flredecomp} and used as the input file for the parallel run.\\\\
After the domain decomposition is complete, the main ATHAM-Fluidity executable is run by issuing the following command from within the same directory:\\\\
\tab \texttt{\$ mpiexec -n Y fluidity <parallel\_input\_file>.flml}\\\\
Note that the extension \texttt{.flml} \textit{is} included at the end of the parallel model options file in this case. Further option flags can also be added to the above command (after the \texttt{fluidity} keyword). For example, \texttt{-v?} (where \texttt{?} is either \texttt{1}, \texttt{2} or \texttt{3}) is a verbose option with 3 different levels (from the least to the most verbose), and \texttt{-l} generates log and error files (one per processor).\\\\
If performing a serial run, the \texttt{flredecomp} stage is not required and the main model executable is simply run using:\\\
\tab \texttt{\$ fluidity <original\_input\_file>.flml}\\\\
Finally, it is noted that for parallel runs, there is a second workflow option available that uses the depreciated \texttt{fldecomp} rather than the \texttt{flredecomp} tool:\\\\
\tab \texttt{\$ fldecomp -n Y <mesh\_file>}\\
\tab \texttt{\$ mpiexec -n Y fluidity <original\_input\_file>.flml}\\\\
where \texttt{<mesh\_file>} is the name of the numerical mesh file (see Section \ref{Mesh}) without the extension, including its relative path if the file is not in the same directory as the \texttt{.flml} file. This is only mentioned here because this second workflow has been found to overcome an as-yet unresolved memory issue with \texttt{flredecomp} when running on a large number (hundreds) of processes.

\section{ATHAM-Fluidity model options} \label{Config}
\textit{\textbf{***Note that ATHAM-Fluidity is still under development, and so many of the options in this section are likely to change or be added to before the model's general release***}}\\
In this section, you will find a description of all the useful ATHAM-Fluidity model options accessible through the diamond GUI. The options listed below correspond to a generic $\mathbb{P}_{1DG}-\mathbb{P}_2$ atmospheric simulation (the recommended finite element discretization method, in which pressure and density are solved on a $2^{\mathrm{nd}}$-order continuous grid while momentum and all other scalars are solved on a $1^{\mathrm{st}}$-order discontinuous grid) for compressible flow, including turbulence and cloud microphysics parameterizations. Refer to the main Fluidity manual for a more detailed description of all the Fluidity options and capabilities. For any option that does not appear below, it can typically be left turned off, or the default option used.\\\\
To launch the diamond GUI type:\\\\
\tab \texttt{\$ diamond <filename>.flml}\\\\
The above command assumes that you have added \texttt{<A-F\_install\_path>/libspud/diamond/bin} to your \texttt{\$PATH} environment variable. If \texttt{<filename>.flml} is omitted, diamond will start with a blank \texttt{.flml} file. Note that when saving the file for the first time, the file extension \texttt{.flml} must be explicitly typed, otherwise the default extension \texttt{.xml} will be added and diamond will complain the next time the file is opened.

\paragraph{General:}
\begin{itemize}
\item \texttt{simulation\_name} will be used to prefix model output files
\item \texttt{problem\_type} must be set to `\texttt{fluids}'
\item \texttt{geometry/dimension} should be set to 2 or 3 depending on whether the test case is a two- or three-dimensional problem. Note that once the \texttt{.flml} file has been saved, this number may not be modified later.
\end{itemize}

\paragraph{Meshes:}
\begin{itemize}
\item \texttt{geometry/mesh (CoordinateMesh)} is the reference mesh, read from the mesh file(s) (thus select \texttt{from\_file}). In the \texttt{Value} field of the \texttt{Attributes} section, type the (relative) path to the mesh file(s), e.g. \texttt{src/MyMesh} if the mesh file(s) are called \texttt{MyMesh} and are located within the subdirectory \texttt{src}.  It is recommended to use the software package \texttt{gmsh} to generate the initial model mesh, in which case \texttt{format (gmsh)} should  be selected.
\item \texttt{geometry/mesh (VelocityMesh)} is the default mesh for the velocity (and non-\seqsplit{pressure/density} scalar) fields, which should be defined from the coordinate mesh. Thus, select \texttt{from\_mesh/mesh (CoordinateMesh)}. \texttt{mesh\_shape/polynomial\_degree} should be set to 1 and \texttt{mesh\_continuity} set to \texttt{discontinuous} (i.e. a $\mathbb{P}_{1DG}$ configuration).
\item \texttt{geometry/mesh (PressureMesh)} is the pressure and density default mesh which again should be defined from the coordinate mesh. Thus, select \texttt{\seqsplit{from\_mesh/mesh (CoordinateMesh)}}. \texttt{mesh\_shape/polynomial\_degree} should be set to 2 and \texttt{mesh\_continuity} set to \texttt{continuous} (i.e. a $\mathbb{P}_2$ configuration).
\item Additional derived meshes can be defined following the above procedure. For example, if temperature is to be solved prognostically, a new mesh called, e.g., \texttt{TemperatureMesh} should be added, with \texttt{from\_mesh/mesh (CoordinateMesh)} selected, \texttt{\seqsplit{mesh\_shape/polynomial\_degree}} set to 1 and \texttt{mesh\_continuity} set to \texttt{disontinuous} (i.e. a $\mathbb{P}_{1DG}$ configuration).
\item \texttt{quadrature/degree} should be set to at least 2N, where N is the  maximum polynomial degree. With the $\mathbb{P}_{1DG}-\mathbb{P}_2$ method, N=2 and so \texttt{quadrature/degree} should be set to 4 (or greater).
\end{itemize}

\paragraph{Input/Output:}
\begin{itemize}
\item \texttt{io/dump\_period/constant} specifies the time period (in seconds) between each set of output files generated by the model.
\item \texttt{io/output\_mesh (PressureMesh)} should be selected in order to generate outputs on the $2^{\mathrm{nd}}$-order pressure/density mesh for better quality.
\item \texttt{io/checkpointing} can be used to generate files for a later restart of the model from a given simulation time (these files consist of gridded data files as well as an updated \texttt{.flml} file). Typically a value would be selected for \texttt{checkpoint\_period\_in\_dumps}. For example, if this is set to 4 then restart files will be generated every 4 dump periods.
\end{itemize}

\paragraph{Time:}
\begin{itemize}
\item \texttt{timestepping/current\_time} specifies the time at the start of the simulation. This is typically set to 0.
\item \texttt{timestepping/timestep} specifies the model time-step (in seconds). This value will depend on the modelled flow-field characteristics and the minimum grid mesh size. If adaptive time stepping is used (often employed with adaptive grid meshing) then this is the initial time-step.
\item \texttt{timestepping/finish\_time} specifies the simulation end-time (in seconds).
\end{itemize}

\paragraph{Physics:}
\begin{itemize}
\item \texttt{physical\_parameters/gravity/magnitude} must be defined, e.g. 9.81 for acceleration due to Earth's gravity.
\item \texttt{physical\_parameters/gravity/vector\_field (GraviryDirection)} is used to prescribe the direction in which gravity acts. For a 2D case, the constants 0 and -1 would be input if the $2^{\mathrm{nd}}$ dimension pointed vertically upwards; for a 3D case, the constants 0, 0 and -1 would be input if the $3^{\mathrm{rd}}$ dimension pointed vertically upwards. 
\item \texttt{material\_phase [name]/equation\_of\_state/compressible} must be selected.
\item \texttt{equation\_of\_state/compressible/giraldo} is the default model for ideal gas and should therefore be selected. (ATHAM will eventually be the default option, but it is currently not operational.)
\item \texttt{equation\_of\_state/compressible/giraldo/reference\_pressure} is the pressure used in the definition of the Exner function (100000 Pa).
\item \texttt{equation\_of\_state/compressible/giraldo/C\_P} and \texttt{C\_V} are the default values for the heat capacities of dry air (constants).
\item \texttt{equation\_of\_state/compressible/giraldo/buoyancy\_from\_pt} allows the user to define buoyancy based on density potential temperature instead of density.
\item \texttt{equation\_of\_state/compressible/giraldo/constant\_cp\_cv}: If turned on, the heat capacities for the moist atmosphere are held constant and equal to their default dry atmosphere values.
\item \texttt{equation\_of\_state/compressible/giraldo/subtract\_out\_reference\_profile}: If turned on, the buoyancy, pressure gradient and scalar diffusion terms are computed by subtracting out the hydrostatic reference state. These reference profiles MUST be defined beforehand, as described in the following.
\end{itemize}

\paragraph{\texttt{material\_phase [name]} prognostic fields:}
\begin{itemize}
\item \texttt{scalar\_field (Pressure)}:
\begin{itemize}
\item \texttt{scalar\_field (Pressure)/prognostic/mesh (PressureMesh)} should be selected.
\item \texttt{spatial\_discretisation/continuous\_galerkin/remove\_stabilisation\_term} should be selected.
\item \texttt{scheme/poisson\_pressure\_solution} should be set to \texttt{never}.
\item \texttt{solver}: Your preferred solver. \texttt{Relative\_error} and \texttt{max\_iterations} are required for the chosen solver (suggested values are 1.0e-7 and 1000).
\item \texttt{initial\_condition}: Specified either via a python script (idealized cases) or read \texttt{from\_file} (non-idealised cases).
\item \texttt{boundary\_conditions (name)}: Setting Dirichlet boundary conditions on all sides and top (chosen via \texttt{select\_ids}) was found to work correctly. The method (\texttt{python} or \texttt{from\_file}) must again be selected.
\item \texttt{boundary\_conditions (name)/from\_file/time\_dependent} allows the user to prescribe time-varying boundary conditions. The number of input files must then be prescribed (see Section \ref{IO} for the required file name formats).
\end{itemize}
\item \texttt{scalar\_field (Density)}
\begin{itemize}
\item \texttt{scalar\_field (Density)/prognostic/mesh (PressureMesh)} should be selected, i.e. the density must be defined on the same continuous mesh as pressure.
\item \texttt{scalar\_field(Density)/prognostic/equation} is not required. The density is diagnosed.
\item \texttt{spatial\_discretisation/continuous\_galerkin/stabilisation/no\_stabilisation} should be selected.
\item \texttt{spatial\_discretisation/continuous\_galerkin/conservative\_advection} is not used as the density is diagnosed.
\item \texttt{temporal\_discretisation/theta}: The value used for time advancing with theta-scheme.
\item \texttt{solver} is necessary if the initial condition is determined from the equation of state. It is recommend to choose the same as the pressure solver. \texttt{relative\_error} and \texttt{max\_iterations} are required for the chosen solver (suggested values are 1.0e-7 and 1000). ***We should change the code so that if not selected, the pressure solver is used automatically/the simulation stopped nicely rather than crashing.***
\item \texttt{initial\_condition}: Specified either via a python script (idealized cases), read \texttt{from\_file} or \texttt{from\_equation\_of\_state} (the density is initially diagnosed using pressure, energy and equation of state; recommended for non-idealized cases for consistency between thermodynamic variables).
\item \texttt{boundary\_conditions} are not necessary if pressure boundary conditions are defined (which is recommended). \texttt{Absorption} specification is not required either.
\end{itemize}
\item \texttt{vector\_field (Velocity)}
\begin{itemize}
\item \texttt{vector\_field (Velocity)/prognostic/mesh (VelocityMesh)} should be selected.
\item \texttt{vector\_field (Velocity)/prognostic/mesh (VelocityMesh)/equation(LinearMomentum)} should be selected.
\item \texttt{spatial\_discretisation/discontinuous\_galerkin} should be selected.
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/viscosity\_scheme/bassi\_rebay} with \texttt{partial\_stress\_form} is recommended for LES or with fixed viscosity.
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/project\_velocity\_to\_continuous}} should be selected.
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/integrate\_advection\_by\_parts/twice}} should be selected.
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/conservative\_advection} should be set to zero.
\item \texttt{temporal\_discretisation/relaxation} should be set to zero.
\item \texttt{temporal\_discretisation/discontinuous\_galerkin/maximum\_courant\_number\_per\_subcycle} should be specified.
\item \texttt{boundary\_conditions}: For the surface, either use \texttt{surface\_ocean\_COARE3} or \texttt{\seqsplit{type(dirichlet)/align\_bc\_with\_cartesian}} with only normal velocity component selected and set to 0 (free slip condition, often sed at domain lid) or all three velocity components selected and set to 0 (no slip condition, often used at domain surface)
\item \texttt{boundary\_conditions}: At the inlet, set the normal velocity components as appropriate. Nothing needs to be set for other boundaries (except possibly top BC as a rigid lid with normal velocity set to 0). There is also the option to use time dependent boundary conditions. BC values are read in from external files (\texttt{from\_file} option) and the number of input files is prescribed (see Section \ref{IO} for the required file name formats).
\item \texttt{vector\_field (Absorption)/diagnostic/algorithm (atmosphere\_forcing\_vector)}: Optional for sponge layers. Possibility to use time dependent conditions consistent with the BC.
\end{itemize}
\item \texttt{scalar\_field (PotentialTemperature)} (This is the default thermal variable used for ATHAM-Fluidity, although the absolute temperature or internal energy may also be used)
\begin{itemize}
\item \texttt{scalar\_field (PotentialTemperature)/prognostic/mesh (VelocityMesh)}: VelocityMesh is the default mesh for any scalar, but a different ScalarMesh can also be defined if desired.
\item \texttt{\seqsplit{scalar\_field (PotentialTemperature)/prognostic/mesh (VelocityMesh)/equation (AdvectionDiffusion)}}: AdvectionDiffusion is the default equation type for any scalar.
\item \texttt{spatial\_discretisation/discontinuous\_galerkin}
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/advection\_scheme/upwind}} is the default upwind flux. \texttt{lax\_friedrichs} may also be used but \texttt{integrate\_advection\_by\_parts} must then be set to once.
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/project\_velocity\_to\_continuous}}
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/integrate\_advection\_by\_parts/twice}}
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/include\_continuity\_residual}}: Optional. This option allows to solve for conservative scalar equations via a correction term added after the pressure solve.
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/slope\_limiter}: \texttt{Vertex\_Based} is the most diffusive but safest option. \texttt{Hermite\_WENO} is less diffusive and works very well in most applications (best choice if it works).
\item \texttt{spatial\_discretisation/subsidence} adds constant subsidence under the form of a large-scale horizontal divergence (possibility to apply subsidence to horizontally averaged field only).
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/conservative\_advection}: 0 (non conservative). Unstable if set to 1 (conservative). Conservation can be achieved with \texttt{include\_continuity\_residual}.
\item \texttt{temporal\_discretisation/discontinuous\_galerkin} with max CFL.
\item \texttt{initial\_condition}: Use python (idealised) or \texttt{from\_file} (non-idealised).
\item \texttt{boundary\_conditions}: For the surface, either use \texttt{surface\_ocean\_COARE3}, \texttt{type (dirichlet)} (\texttt{python} or \texttt{from\_file}), or nothing (zero-gradient).
\item \texttt{boundary\_conditions}: At inlet, use Dirichlet (do not \texttt{apply\_weakly}). Nothing to be set for other boundaries (do not define other boundaries). Possibility to use time dependent boundary conditions. BC values are read in external files (\texttt{from\_file} option) and the number of input files is prescribed (see section \ref{IO}).
\item \texttt{scalar\_field (Absorption)/diagnostic/algorithm (atmosphere\_forcing\_scalar)}: Optional for sponge layers.
\item \texttt{galerkin\_projection/discontinuous} should be selected.
\end{itemize}
\item \texttt{scalar\_field (VapourWaterQ)} (water vapor fraction, recommended for moist processes. \texttt{TotalWaterQ} is also a possible choice.)
\begin{itemize}
\item \texttt{scalar\_field (VapourWaterQ)/prognostic/mesh (VelocityMesh)}: VelocityMesh is the default mesh for any scalar, but a different ScalarMesh can also be defined.
\item \texttt{\seqsplit{scalar\_field (VapourWaterQ)/prognostic/mesh (VelocityMesh)/equation (AdvectionDiffusion)}}
\item \texttt{spatial\_discretisation/discontinuous\_galerkin} should be selected.
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/advection\_scheme/upwind}} is the default upwind flux. \texttt{lax\_friedrichs} may also be used but \texttt{integrate\_advection\_by\_parts} must then be set to once.
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/project\_velocity\_to\_continuous}}
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/integrate\_advection\_by\_parts/twice}}
\item \texttt{\seqsplit{spatial\_discretisation/discontinuous\_galerkin/advection\_scheme/include\_continuity\_residual}}: Optional. This allows to solve for conservative scalar equations via a correction term added after the pressure solve. 
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/slope\_limiter}: \texttt{Vertex\_Based} is the most diffusive but safest option. \texttt{Hermite\_WENO} is less diffusive and works very well in most applications (best choice if it works).
\item \texttt{spatial\_discretisation/subsidence} adds constant subsidence under the form of a large-scale horizontal divergence (possibility to apply subsidence to horizontally averaged field only).
\item \texttt{spatial\_discretisation/discontinuous\_galerkin/conservative\_advection}. 0 (non conservative). Unstable if set to 1 (conservative). Conservation can be achieved with \texttt{include\_continuity\_residual}.
\item \texttt{temporal\_discretisation/discontinuous\_galerkin} with max CFL
\item \texttt{initial\_condition}: Use \texttt{python} (idealised) or \texttt{from\_file} (non-idealised).
\item \texttt{boundary\_conditions}: For the surface, either use \texttt{surface\_ocean\_COARE3}, \texttt{type(dirichlet)} (\texttt{python} or \texttt{from\_file}), or nothing (zero-gradient).
\item \texttt{boundary\_conditions}: At inlet use Dirichlet (do not \texttt{apply\_weakly}). Nothing to be set for other boundaries (do not define other boundaries). Possibility to have \texttt{time\_dependent} BCs.
\item \texttt{scalar\_field (Absorption)/diagnostic/algorithm (atmosphere\_forcing\_scalar)}: Optional for sponge layers.
\item \texttt{galerkin\_projection/discontinuous}
\end{itemize}
\item Any other prognostic scalar can be defined in the same way.
\end{itemize}

\paragraph{\texttt{material\_phase [name]} prescribed fields:}
\begin{itemize}
\item Typically used to specify an initial reference (hydrostatic) state
\item \texttt{scalar\_field (HydrostaticReferencePressure)} defined on \texttt{PressureMesh} and initialized in same way as the pressure but without perturbations. Used in evaluation of pressure gradient term.
\item \texttt{scalar\_field (HydrostaticReferenceDensity)} defined on \texttt{PressureMesh} and initialized in the saem way as the density but without perturbations. Used in buoyancy calculation.
\item \texttt{scalar\_field (HydrostaticReferencePotentialTemperature)} defined on \texttt{VelocityMesh} (or \texttt{ScalarMesh}) and initialized in the same way as the potential temperature but without perturbations. Used in buoyancy calculation (if selected) and in the turbulent diffusion operator.
\item \texttt{scalar\_field (HydrostaticReferenceScalarName)} defined on \texttt{VelocityMesh} (or \texttt{ScalarMesh}) and initialized in the same way as the scalar but without perturbations. Used in the turbulent diffusion operator.
\item If \texttt{value/from\_file/time\_dependent} selected, the prescribed field will vary in time (the BCs and sponge layer values should also be \texttt{time\_dependent})
\item It may be necessary to choose a \texttt{solver} even for prescribed fields (no solver by default) in the case when projections will be performed.
\end{itemize}

\paragraph{\texttt{material\_phase [name]} diagnostic fields:}
\begin{itemize}
\item \texttt{vector\_field (DG\_CourantNumber)}: MUST be selected in list of available diagnostics with DG.
\item Atmosphere specific diagnostics: \texttt{Saturation}, \texttt{Reflectivity}, \texttt{VapourWaterQ} (default is prognostic but can be diagnosed), \texttt{CompressibleContinuityResidual} (for conservative form). All are present in default list, with \texttt{algorithm (internal)}.
\item Atmospheric surface diagnostics: \texttt{SurfaceTemperature}, \texttt{SurfacePrecipitation}, \texttt{LiquidWaterPath}... Defined on scalar mesh, with \texttt{algorithm(internal)}. \texttt{boundary\_conditions (diagnostic)} field is active with \texttt{surface\_ids} corresponding to surface BC, \texttt{parent\_field\_name} is name of reference field (e.g. \texttt{Qdrop}), and type is selected in list to match diagnostic field name. \texttt{LiquidWaterPath} and \texttt{CloudCover} require vertical integrals which are computed by first averaging in the vertical direction (using iterative Helmholtz diffusive filter with recommended length scale alpha $\approx$ domain height) and then multiplying by domain height.
\end{itemize}

\paragraph{LES parameterization:}
\begin{itemize}
\item \texttt{field/prognostic/spatial\_discretisation/disontinuous\_galerkin/les\_model} (specific implementation for DG).
\item \texttt{les\_model/tensor\_field (EddyViscosity)} for velocity or \texttt{\seqsplit{les\_model/tensor\_field (ScalarNameDiffusivity)}} for scalars.
\item \texttt{les\_model/tensor\_field (name)/diagnostic/algorithm (internal)} (and must be defined on same mesh as the main variable).
\item \texttt{les\_model/tensor\_field(SFSLeonard)} is optional, to be defined with non\_linear model.
\item Default methods are \texttt{second\_order (Smagorinsky)} or \texttt{non\_linear} (Kosovic, for velocity only) (with appropriate constants as suggested)
\item For \texttt{second\_order}: \texttt{buoyancy\_correction} (turbulence inhibition or enhancement depending on stability, \texttt{Brown} is default)
\end{itemize}

\paragraph{Sponge layers and nudging:}
\begin{itemize}
\item \texttt{scalar\_field (Absorption)/diagnostic/algorithm (atmospher\_forcing\_scalar)} (or equivalent for vector - velocity).
\item \texttt{algorithm (atmospher\_forcing\_scalar)/from\_file} or \texttt{python} (depending on  initialization method). Possibility to define time varying layers with \texttt{time\_dependent}.
\item \texttt{algorithm (atmospher\_forcing\_scalar)/sponge\_layer\_scalar\_absorption/coefficient}: relaxation coefficient in sponge layer (0.25?)
\item Possibility to define layers along each boundary: top (\texttt{z\_sponge}), or sides (\texttt{x\_sponge} and \texttt{y\_sponge}). The position of the sponge layer (base) must be specified (in m).
\item \texttt{algorithm(atmospher\_forcing\_scalar)/scalar\_nudging}: \texttt{time\_scale} is relaxation time and \texttt{\seqsplit{use\_horizontal\_mean}} applies nudging to horizontal averages instead of local scalar values (horizontal means are computed by iterating a Helmholtz (diffusion operator) filter in the horizontal with recommended length scale alpha $\approx$ domain length).
\end{itemize}

\paragraph{Cloud microphysics:}
\begin{itemize}
\item \texttt{cloud\_microphysics/time\_integration (Direct)}, default integration for microphysics, integrates microphysics source terms directly within the advection step
\item \texttt{cloud\_microphysics/time\_integration (Splitting)}, time-split method for microphysics where microphysics is integrated independently after the main time marching loop
\item \texttt{cloud\_microphysics/time\_integration (Strang)}, time-split method for microphysics where microphysical variables are advanced by half a time-step before the main integration sequence and half a time-step after
\item \texttt{cloud\_microphysics/time\_integration/limit\_after\_advance} applies slope limiter after microphysics step (when computed independently from the rest)
\item \texttt{cloud\_microphysics/relaxation} (optional) sets the relaxation parameter for the calculation of microphysics sources (when 0, values from previous time-step are used)
\item \texttt{cloud\_microphysics/condensation\_evaporation(saturation\_adjustment)} uses the saturation adjustment procedure to calculate liquid content 
\item \texttt{cloud\_microphysics/condensation\_evapration (Simple)} diffusion/evaporation sources are computed and treated implicitly
\item \texttt{cloud\_microphysics/condensation\_evapration (Analytic)} diffusion/evaporation sources are computed and treated analytically (recommended)
\item \texttt{cloud\_microphysics/condensation\_evapration (Adaptive)} diffusion/evaporation sources are computed and a 2nd order backward difference method with variable step size is used to guarantee 2nd order accuracy
\item \texttt{cloud\_microphysics/no\_negative\_concentrations} applies a strong limit to concentrations
\item \texttt{cloud\_microphysics/diagnostic}: Only mass mixing ratios of liquid drops can be included (\texttt{Qdrop} or \texttt{Qrain}) and although they are advected (prognostic quantities), only \texttt{saturation\_adjustment} to diagnose microphysical processes
\item \texttt{cloud\_microphysics/fortran\_microphysics}: Full microphysical schemes
\item \texttt{cloud\_microphysics/fortran\_microphysics/scalar\_field (MicrophysicsSource)} defines options related to the microphysics sources (must be diagnostic, defined on the same mesh as the microphysical quantities)
\item \texttt{cloud\_microphysics/fortran\_microphysics/scalar\_field (SinkingVelocity)} same as above
\item \texttt{cloud\_microphysics/fortran\_microphysics/two\_moment\_microphysics (seifert\_beheng)} is the default microphysical scheme from Seifert and Beheng (only warm phase microphysics implemented so far). 5 prognostic quantities must be defined (CCN, Ndrop, Qdrop, Nrain and Qrain). Some can be directly prescribed (CCN and Ndrop in particular, in which case only one moment is computed for droplets). See prognostic scalar definition above to setup these fields
\item \texttt{two\_moment\_microphysics (seifert\_beheng)/cold\_microphysics} switches on ice particles and cold microphysics. Although no proper ice microphysics is implemented, there is already the possibility to define ice particle quantities.
\item \texttt{two\_moment\_microphysics (seifert\_beheng)/autoconversion\_radius} sets the auto conversion radius for the scheme (default is 40 microns)
\item \texttt{two\_moment\_microphysics (seifert\_beheng)/simple\_activation} droplets are systematically formed in supersaturated regions and Ndrop is directly set to the prescribed number of CCN (from CCN scalar field)
\item \texttt{two\_moment\_microphysics (seifert\_beheng)/detailed\_activation} activation of new cloud droplets uses a simple model based on Kohler theory but for a single  mono-modal aerosol type
\item \texttt{two\_moment\_microphysics (morrison)} is the same as \texttt{seifert\_beheng} but uses parts of Morrison’s scheme and Kogan’s scheme (not as well implemented as seifert and beheng)
\item \texttt{one\_moment\_microphysics (kessler)} one moment scheme where only Qdrop and Qrain are prognostic while Ndrop is prescribed and Nrain diagnostic. Uses Kessler auto conversion plus parts of Thompson’s scheme. \texttt{mass\_threshold} is for auto conversion 
\end{itemize}


\paragraph{Others:}
\begin{itemize}
\item \texttt{mesh\_adaptivity} contains the options defining a grid adaptive simulation
\item \texttt{radiation\_model} is a template for configuration options related to a radiation transfer model. The current options are actually not used in the code as the RRTM is not fully coupled yet.
\item \texttt{flredecomp} contains options relative to domain decomposition using flredecomp. If problems related to the ParMETIS library arise (see Section \ref{Dependencies}), typically observed when executing flredecomp, a different partitioner can be used. In this case, \texttt{\seqsplit{flredecomp/final\_partitioner/zoltan/method [hypergraph]}} will be preferred. If nothing is specified, the ParMETIS graph is used for partitioning.
\end{itemize}

\section{Creating a numerical mesh} \label{Mesh}
The numerical meshes for ATHAM-Fluidity are generated using the external software \texttt{Gmsh}. The \texttt{Gmsh} binaries (or source code) can be downloaded from \url{http://gmsh.info/#Download}. If building \texttt{Gmsh} from source, following the installation instructions within the included README file.\\\\
Generating the mesh is a two stage process. The geometry of the modelling domain and mesh resolution parameters (plus any additional options) must first be specified in an ASCII text file with the extension \texttt{.geo}. Guidance on the format of these geometry files, as well as some examples, can be found in the \texttt{Gmsh} reference manual, available here: \url{http://gmsh.info/doc/texinfo/gmsh.pdf}. Users could also look at the \texttt{.geo} files included with the ATHAM-Fluidity test cases/examples (see Section \ref{Tests}). The modelling domain and mesh can also be visualised within the \texttt{Gmsh} GUI, which is launched by typing:\\\\
\tab \texttt{\$ gmsh <mesh\_file>.geo}\\\\
Once the geometry file has been created, the \texttt{Gmsh} executable should be invoked to read the contents of this \texttt{.geo} and generate a corresponding \texttt{.msh} file - a much larger file that contains a list of all the mesh elements and node coordinates:\\\\
\tab \texttt{\$ gmsh -N <other options> <mesh\_file>.geo}\\\\
where \texttt{N} is the dimension of the modelling domain (i.e. 2 or 3). Useful `\texttt{other options}' include \texttt{-bin}, which writes the \texttt{.msh} file in binary rather than ASCII format (thereby saving disc space) and \texttt{-optimize}. This latter option can be very important when generating a fully unstructured mesh within a complex geometry (e.g. above a topographical surface) as it passes over the mesh a second time to ensure that there are no `bad' (i.e. very small) elements that might dramatically reduce a CFL-limited model timestep.

\section{ATHAM-Fluidity test cases and examples} \label{Tests}
\subsection{Test cases}
A number of 2-dimensional test cases have been included with the ATHAM-Fluidity source code (under the `\texttt{tests}' subdirectory). These comprise a series of benchmark and idealized atmospheric simulations that were originally performed in order to evaluate ATHAM-Fluidity. Full details and results of these simulations can be found in Savre \textit{et al.} (2016, Monthly Weather Review, 144:4349-4372). Note, however, that due to subsequent code changes and/or tweaks to model parameters, results will be similar but not identical to those presented in this paper. A brief description of each test case is also given below:

\begin{itemize}
\item \texttt{warm\_bubble}: A positive Gaussian potential temperature perturbation is initially imposed in an otherwise neutral and static environment in hydrostatic balance. This results in a rising smooth warm bubble with a Kelvin-Helmholtz rotor developing on each side of the bubble. The configuration from Savre \textit{et al.} (2016) that uses a 10 m spatial resolution is specified.
\item \texttt{warm\_bubble\_adapt}: Same as the \texttt{warm\_bubble} test case, but using mesh optimisation. The minimum edge length (maximum resolution) is set to 5 m and the maximum edge length (coarsest resolution) is set to 250 m. Optimisation is computed based on a target absolute interpolation error for potential temeprature.
\item \texttt{density\_current}: A negative Gaussian potential temperature perturbation is initially imposed in an otherwise neutral and static environment in hydrostatic balance. This rapidly sinks, hits the solid surface and spreads out as a cold density current with three rotors on each side. The configuration from Savre \textit{et al.} (2016) that uses a 200 m spatial resolution is specified.
\item \texttt{warm\_cold\_bubbles}: This case is similar to the \texttt{warm\_bubble} set-up with the addition of a second smaller cold bubble above and off-centre with the warm bubble. As time progresses, these bubbles collide and mix. The configuration from Savre \textit{et al.} (2016) that uses a 10 m spatial resolution is specified.
\item \texttt{inertial\_gravity\_waves}: This case involves a horizontally propagating nonhydrostatic gravity wave in a channel, resulting from an initial potential temperature perturbation in an otherwise uniformly stratified atmosphere with homogeneous horizontal flow. The configuration from Savre \textit{et al.} (2016) that uses an adaptive timestep based on a CFL number of 0.25 is specified.
\item \texttt{schar\_mountain}: In this case, a dry atmospheric flow is forced over a five-peak mountain range with constant velocity, producing steady-state gravity waves. The configuration differs from Savre \textit{et al.} (2016) in that the simulation time has been reduced from 8 h to 0.5 h to keep the runtime down (this could be easily changed back in the \texttt{.flml} file).
\item \texttt{single\_mountain}: In this case, a dry atmospheric flow is forced ocer a single linear mountain profile with constant velocity. Similarly, the configuration differs from Savre \textit{et al.} (2016) in that the simulation time has been reduced from 5 h to 0.5 h.
\end{itemize}
As well as the \texttt{.flml} and mesh geometry files, each of the above test directories also includes an \texttt{.xml} file that can be used to automate the execution of each test case and a subsequent comparison of the model output against stored results (for the benefit of model development testing). To run a particular test case, issue the following command:\\\\
\tab \texttt{\$ <A-F\_install\_path>/tools/testharness.py -f <test\_case>.xml}\\\\
where \texttt{<test\_case>} should be replaced by one of the test case names above, e.g. \texttt{warm\_bubble}. To run all the test cases in succession, issue the following command:\\\\
\tab \texttt{\$ <A-F\_install\_path>/tools/testharness.py -t atham -l long}\\\\
Note that all the above test cases are set up to run in parallel on \textit{24 processes} in order to keep runtimes down. If you are using a machine that does not have this many processes (or if you want use more processes!), you should open the relevant \texttt{.xml} file(s) in a text editor and modify this value (it appears in two places near the top of each file) as appropriate.

\subsection{Example cases}
A number of 2- and 3-dimensional examples have also been included with the ATHAM-Fluidity source code (under the `\texttt{examples}' subdirectory). A brief description of each example is given below:

\begin{itemize}
\item \texttt{squall\_line}: This simulation of a 2-d squall line is often used as a benchmark to evaluate cloud microphysics codes. An initially dry but convectively unstable atmosphere is perturbed by a low-level warm bubble, which initiates a moist convection cell. A vertical velocity profile with low-level wind shear aids the formation of a long-lived squall line, as precipitation from one cell causes evaporative cooling at the surface, creating a cold pool that spreads out as a density current. On the upwind side, the vorticity associated with the spreading cold pool counteracts the vorticity associated with the ambient low-level shear, producing deeper lifting and thus maintaining the cell regeneration process.
\item \texttt{rain}: This 3-d boundary-layer-scale simulation involves a logarithmic velocity profile, a constant potential temperature profile up to 1000 m with an inversion above this, and a moisture profile that gives a stratified layer of saturated air (clouds) just below the inversion. Turbulence is generated at the domain inlet using Fluidity's synthetic-eddy method. A spatially varying surface boundary condition for potential temperature is defined, where the surface in the last two thirds of the domain is 5K warmer than the upwind third. This generates thermals, leading to convectively-driven cloud and precipitation formation in the downwind half of the domain later in the simulation.
\item \texttt{precip\_extreme}: This simulation represents a simplified version of a case study performed as part of the EU PEARL project (Preparing for Extreme And Rare events in coastaL regions). An extreme pricipitation event, as simulated by a regional climate model, is downscaled close to the region of interest (Greve, Denmark). A simplified numerical mesh without topography or distinct land-sea regions is adopted, with the horizontal domain extent also reduced from 100 x 100 km to 100 x 0.6 km to accommodate the use of modest computational resources (the set-up uses 24 cores by default). If the user has access to a larger number of cores, a mesh geometry file with the full horizontal extent of 100 x 100 km is also supplied. A version of the model input (\texttt{.flml}) file in which the inlet velocity profile is scaled to give a maximum of 10 $\mathrm{m \, s^{-1}}$ is also included - this reduces the (CFL-limited) timestep for a faster runtime and also allows for the generation of convective clouds closer to the inlet (these clouds form due to the advection of a convectively unstable atmosphere into the domain and the vertical perturbations provided by the inlet turbulence generator).
\item \texttt{sealevel\_extreme}: This simulation represents a simplified version of a second case study performed for PEARL. An extreme sea-level event predicted by the regional climate model is downscaled close to Greve. The same simplified numerical mesh (no topography or distinct land-sea regions, reduced horizontal extent) as in the previous example is adopted.
\end{itemize}
Any one of these examples can be run by navigating to the relevant directory and issuing the following commands:\\\\
\tab \texttt{\$ make preprocess}\\
\tab \texttt{\$ make run}\\\\
To clean the output from a previous run, the following command can be used:\\\\
\tab \texttt{\$ make clean}

\section{Input/output files} \label{IO}
By default, the main output files are exported in \texttt{.vtu} format. These are directly readable by the ParaView free software (which can also be found on Darwin). In parallel runs, as many files as there are processes are produced, and stored in a separate subdirectory for each output time. A \texttt{.pvtu} file is also created in the main directory to unify all the sub-domains in ParaView. A \texttt{.stat} file is also created and updated after each time-step. It contains runtime information on each defined variable (plus others) such as domain averages and min or max values. The file is readable directly or by using the \texttt{statplot} visualisation tool which comes with the model source code.\\\\
In addition to the \texttt{.flml} and mesh files required to run ATHAM-Fluidity, other input files may be necessary. For example, for non-idealized cases for which it is not possible to initialize the simulations using a built-in python script, initial atmospheric soundings can be provided (select the \texttt{from\_file/type (sounding)} option under \texttt{intial\_conditions} and/or \texttt{boundary\_condition}) to homogeneously initialize the domain. These soundings possess a very standard and easy to read structure: the first line contains the values of the surface pressure (hPa), near-surface potential temperature (K), near-surface vapor mixing ratio ($\mathrm{kg \, m^{-3}}$) and near-surface horizontal velocity components ($\mathrm{m \, s^{-1}}$). Then, the 1D variables are stored in columns: first the altitude (m) then the potential temperature, the vapor mixing ratio and the horizontal velocities (vertical velocities are set to 0).\\\\ 
If \texttt{time\_dependent} boundary conditions are requested (or for sponge layers and nudging), the number of input files to be provided must be prescribed. These files all have the same base name (to be specified in diamond), with an extension indicating the time of the sounding (the first one being 0): e.g. \texttt{SOUNDING.00000} (first one), \texttt{SOUNDING.07200} (after 2h), \texttt{SOUNDING.14400} (after 4h)... Linear interpolations in time are performed between soundings. Note that this feature has not yet been fully implemented and tested in the code.


%\bibliography{../../References/MyBib}

\end{document}